// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// Usuario de la plataforma
model User {
  id            String        @id @default(uuid())
  walletAddress String?       @unique
  email         String        @unique
  password      String
  name          String?
  nickname      String?
  isVerified    Boolean       @default(false)
  role          UserRole      @default(USER)
  xpPoints      Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  transactions  Transaction[]
  proposals     Proposal[]
  reviews       Review[]
  membership    UserMembership?
  userCoupons   UserCoupon[]

  @@index([email])
  @@index([walletAddress])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

// Productos del Marketplace
model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  priceFELI   Int      // Precio en FELI (sin decimales, usar wei)
  priceUSD    Float?   // Precio equivalente en USD
  category    String
  stock       Int      @default(0)
  imageUrl    String?
  cashback    Int      @default(0) // Porcentaje de cashback
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions Transaction[]
  reviews      Review[]

  @@index([category])
}

// Eventos con tickets NFT
model Event {
  id                  String   @id @default(uuid())
  blockchainEventId   Int?     @unique // ID del evento en el smart contract
  name                String
  description         String?
  eventDate           DateTime // Renombrado de 'date' para claridad
  location            String?
  ticketPrice         Float    // Precio en FELI
  maxTickets          Int      // Renombrado de maxSupply
  ticketsSold         Int      @default(0) // Renombrado de sold
  nftContractAddress  String?  // Dirección del contrato NFT específico
  imageUrl            String?
  metadataURI         String?  // URI de metadata del NFT
  requiresVerification Boolean @default(false)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  transactions Transaction[]

  @@index([blockchainEventId])
}

// Propuestas de gobernanza (DAO)
model Proposal {
  id          String         @id @default(uuid())
  onChainId   Int?           @unique // ID en el contrato Governor
  title       String
  description String
  proposer    User           @relation(fields: [proposerId], references: [id])
  proposerId  String
  status      ProposalStatus @default(ACTIVE)
  forVotes    Int            @default(0)
  againstVotes Int           @default(0)
  startTime   DateTime       @default(now())
  endTime     DateTime?
  executed    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([status])
}

enum ProposalStatus {
  DRAFT
  ACTIVE
  PASSED
  REJECTED
  EXECUTED
}

// Transacciones (registra todas las actividades)
model Transaction {
  id          String            @id @default(uuid())
  txHash      String            @unique
  type        TransactionType
  user        User?             @relation(fields: [userId], references: [id])
  userId      String?
  product     Product?          @relation(fields: [productId], references: [id])
  productId   String?
  event       Event?            @relation(fields: [eventId], references: [id])
  eventId     String?
  amount      String            // Cantidad en FELI (String para BigInt)
  status      TxStatus          @default(PENDING)
  metadata    Json?             // Datos adicionales (cashback, etc)
  blockNumber Int?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
}

enum TransactionType {
  PURCHASE
  TICKET_PURCHASE
  STAKING
  STAKING_WITHDRAW
  STAKE
  UNSTAKE
  VOTE
  MINT_TICKET
  TRANSFER_IN
  TRANSFER_OUT
  CASHBACK
  STAKING_REWARD
  REWARD
}

enum TxStatus {
  PENDING
  CONFIRMED
  FAILED
}

// Reseñas de productos
model Review {
  id          String   @id @default(uuid())
  product     Product  @relation(fields: [productId], references: [id])
  productId   String
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  rating      Int      // De 1 a 5
  comment     String?
  isVerified  Boolean  @default(false) // Si el usuario compró el producto
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([userId])
}

// Configuración del sistema
model Config {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Cupones disponibles
model Coupon {
  id               String      @id @default(uuid())
  code             String      @unique
  title            String
  description      String?
  discount         Int         // Porcentaje de descuento (10 = 10%)
  cost             Int         // Costo en FELICOINS para canjear
  category         String      // Tecnología, Cashback, Envío, Productos
  expiresAt        DateTime?   // Fecha de expiración
  maxUses          Int         @default(1) // Máximo de usos por cupón
  maxRedemptions   Int?        // Máximo de veces que se puede canjear (null = ilimitado)
  redemptionsCount Int         @default(0) // Contador de canjes
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  userCoupons UserCoupon[]

  @@index([category])
  @@index([isActive])
}

// Cupones de usuarios (relación muchos a muchos)
model UserCoupon {
  id         String    @id @default(uuid())
  user       User      @relation(fields: [userId], references: [id])
  userId     String
  coupon     Coupon    @relation(fields: [couponId], references: [id])
  couponId   String
  redeemedAt DateTime  @default(now()) // Fecha de canje
  usedAt     DateTime? // Null si no se ha usado
  isUsed     Boolean   @default(false)
  purchaseId String?   // ID de la transacción donde se usó
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([userId, couponId])
  @@index([userId])
  @@index([couponId])
}

// Membresía de usuarios
model UserMembership {
  id          String          @id @default(uuid())
  user        User            @relation(fields: [userId], references: [id])
  userId      String          @unique
  level       MembershipLevel @default(SILVER)
  apy         Float           @default(3.0) // APY según nivel
  cashback    Int             @default(5) // % de cashback base
  benefits    Json?           // Beneficios adicionales
  updatedAt   DateTime        @updatedAt
  createdAt   DateTime        @default(now())

  @@index([level])
}

enum MembershipLevel {
  SILVER
  GOLD
  PLATINUM
}

